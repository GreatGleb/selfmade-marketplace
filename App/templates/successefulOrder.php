<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Оформление заказа</title>

	<meta name="format-detection" content="telephone=no">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<meta name="description" content="О Saterno">
	<meta name="keywords" content="О интернет магазине Сатерно">

	<link rel="stylesheet" href="App/templates/files/bootstrap.min.css">
	<link rel="stylesheet" href="App/templates/files/font-awesome.min.css">
	<link rel="stylesheet" href="App/templates/files/lib.css">
	<link rel="stylesheet" href="App/templates/files/ie9-and-up.css">
	<link rel="stylesheet" href="App/templates/files/style.css">
	<link rel="stylesheet" href="App/templates/files/style(1).css">
	<link rel="stylesheet" href="App/templates/files/so_sociallogin.css">
	<link rel="stylesheet" href="App/templates/files/so_searchpro.css">
	<link rel="stylesheet" href="App/templates/files/so_megamenu.css">
	<link rel="stylesheet" href="App/templates/files/wide-grid.css">
	<link rel="stylesheet" href="App/templates/files/custom.css">
	<link rel="stylesheet" href="App/templates/files/owl.carousel.css">
	<link rel="stylesheet" href="App/templates/files/orange.css">
	<link rel="stylesheet" href="App/templates/files/header1.css">
	<link rel="stylesheet" href="App/templates/files/footer1.css">
	<link rel="stylesheet" href="App/templates/files/responsive.css">
	<script async="" src="App/templates/files/js/tag.js"></script>
	<link rel="stylesheet" href="App/templates/files/css/popUp.css">
	<link rel="stylesheet" href="App/templates/files/css/buyCart.css">
	<link rel="stylesheet" href="App/templates/files/css/inputsAndTextareasDefault.css">
	<script src="App/templates/files/js/jquery-2.1.1.min.js"></script>
	<script src="App/templates/files/js/bootstrap.min.js"></script>
	<script src="App/templates/files/js/libs.js"></script>
	<script src="App/templates/files/js/so.system.js"></script>
	<script src="App/templates/files/js/so.custom.js"></script>
	<script src="App/templates/files/js/common.js"></script>
	<script src="App/templates/files/js/jquery.unveil.js"></script>
	<script src="App/templates/files/js/owl.carousel.js"></script>
	<script src="App/templates/files/js/script.js"></script>
	<script src="App/templates/files/js/so_megamenu.js"></script>
	<link href="App/templates/files/css/successefulOrder.css" rel="stylesheet">

	<link href="App/templates/index_files/saternologomini.jpg" rel="icon">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300,700,900' rel='stylesheet' type='text/css'> 	
	<link rel="stylesheet" href="App/templates/files/css/styleForAll.css">
</head>

<body class="information-information-4 ltr res layout-1   loaded">

<?php require(__DIR__ . "/files/html/modal_sign_to_account.html");?>

<div id="wrapper" class="wrapper-full banners-effect-7">   
	
		<div class="loader-content">
		<div id="loader">
						<div class="cssload-thecube">
						<div class="cssload-cube cssload-c1"></div>
						<div class="cssload-cube cssload-c2"></div>
						<div class="cssload-cube cssload-c4"></div>
						<div class="cssload-cube cssload-c3"></div>
						</div>
				</div>
	</div>

<?php require(__DIR__ . "/files/html/header.html");?>
	
	<div id="socialLogin"></div>

<div class="container">
  <div class="">
                      <div id="content" class="">
		
        <div class="container">

<div class="modalBlock toggleModal0" data-toggle="true" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDescription" data-state="close" style="overflow: auto;">
  <div class="modal__block">
	<div class="modalHeader">
		<div class="title">Выбор модели</div>
		<button class="modal__close toggleModal0" data-toggle="true">
			<svg width="14" height="14" viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg">
				<path d="M8.414 7l4.95-4.95L11.948.638 7 5.587 2.05.636.638 2.05 5.587 7l-4.95 4.95 1.414 1.413L7 8.413l4.95 4.95 1.413-1.414L8.413 7z" fill-rule="evenodd"></path>
			</svg>
		</button>
	</div>			
	<div class="modalBody">
		<div>
		    <p>Добавление товара «<span class="product-title"></span>» в корзину</p>
		    <div class="price" style="">
		        <p class="price-title" style="margin: 0; line-height: 0.8; font-size: 13px; font-weight: 400; color: #3b3b3b">Цена</p>
		        <p class="price-value" style=" font-size: 21px; font-weight: 900; "></p>
		    </div>
		    <div class="atributes">
		        
		    </div>
		    <p class="pButtonBuy" style="margin: 0; padding: 10px;">
    		    <span class="svg buttonBuy">
        			<svg height="24" width="24" style="fill: #000;cursor: pointer;">
        			    <svg viewBox="0 0 24 24" id="icon-basket">
                        	<g>
                        		<path fill-rule="evenodd" clip-rule="evenodd" d="M1 2C0.447715 2 0 2.44772 0 3C0 3.55228 0.447715 4 1 4H2.68121C3.08124 4 3.44277 4.2384 3.60035 4.60608L8.44161 15.9023C9.00044 17.2063 10.3963 17.9405 11.7874 17.6623L19.058 16.2082C20.1137 15.9971 20.9753 15.2365 21.3157 14.2151L23.0712 8.94868C23.7187 7.00609 22.2728 5 20.2251 5H5.94511L5.43864 3.81824C4.96591 2.71519 3.88129 2 2.68121 2H1ZM10.2799 15.1145L6.80225 7H20.2251C20.9077 7 21.3897 7.6687 21.1738 8.31623L19.4183 13.5827C19.3049 13.9231 19.0177 14.1767 18.6658 14.247L11.3952 15.7012C10.9315 15.7939 10.4662 15.5492 10.2799 15.1145Z"></path>
                        		<path d="M11 22C11 23.1046 10.1046 24 9 24C7.89543 24 7 23.1046 7 22C7 20.8954 7.89543 20 9 20C10.1046 20 11 20.8954 11 22Z"></path>
                        		<path d="M21 22C21 23.1046 20.1046 24 19 24C17.8954 24 17 23.1046 17 22C17 20.8954 17.8954 20 19 20C20.1046 20 21 20.8954 21 22Z"></path>
                        	</g>
                        </svg>
        			</svg>
    			</span>
			</p>
		</div>
	</div>
	
  </div>
</div>

<?php require(__DIR__ . "/files/html/buy-cart-module.html"); ?>

<?php require(__DIR__ . "/files/html/right_menu.html"); ?>

<div id="cover"></div>
<div id="cover2"></div>
<div id="cover3"></div>

<script src="App/templates/files/js/popUp.js"></script>
<script src="App/templates/files/js/buyCartModule.js"></script>

<div class="checkout-success checkout-success--payment">
    <div class="checkout-success__inner">
        <div class="checkout-success__top" style="color: #000;">
            <div class="success__top-ura">Ура! Всё получилось!</div>
            <div class="success__top-main">Ваш заказ <strong>оформлен!</strong></div>
        </div>
        <div class="checkout-success__bottom">
            <div class="success__num">Номер вашего заказа  #<span id="orderId"></span></div>
            <div class="success__contact"><b>Для контакта со службой доставки, пожалуйста, используйте:</b><strong>Телефон : +<span id="deliveryPhone"></span></strong>
            </div>
        </div>
    </div>
</div>

</div>
            </div>
      </div>
</div>
	
<script>
    let postJSON = function(data, url, successHandler, errorHandler) {
    	console.log('post');
    	let xhr = new XMLHttpRequest();
    
    	let json = JSON.stringify(data);
    
    	xhr.open("POST", url);
    	//xhr.responseType = 'json';
    	xhr.setRequestHeader('Authorization', '42b33d37-8701-417c-8418-7c8577c678fa');
    
    	xhr.setRequestHeader('Content-type', 'application/json');
    	//xhr.setRequestHeader('Api-Version', '2');
    	xhr.onreadystatechange = function() {
    		let status;
    		let data;
    		
    		if (xhr.readyState == 4) { // `DONE`
    			status = xhr.status;
    			if (status == 200) {
    				successHandler && successHandler(xhr.response);
    			} else {
    				errorHandler && errorHandler(status);
    			}
    		}
    	};
    
    	xhr.send(json);
    }

    let ordersId = [];
    let ordersJSON = [];
</script>

<?php $_SESSION['deliveryOrders'] = NULL;

$i = 0;

foreach($ordersId as $order) {
    echo "<script>
            ordersId.push('" . $order . "');
            ordersJSON.push(JSON.parse('" . $ordersJSON[$i] . "'));
        </script>";
    $i++;
}

?>

<script>
    let i = 0;
    
    for(let order of ordersId) {
        order = order.split(',');
        let url = 'https://api.dostav.im/Order/Create?isDraft=false&callCourier=' + order[1];
        if(ordersJSON[i]['TariffId'] != undefined && ordersJSON[i]['TariffId'] != '') {
            postJSON(ordersJSON[i], url, function(data) {
                let result = JSON.parse(data);
    			console.log(result);
    			
    			let orderId = result['result']['orderId'];
    			document.querySelector('#orderId').innerHTML = orderId;
    			
    			let providerNumber = result['result']['dsProviderNumber'];
    			document.querySelector('#deliveryPhone').innerHTML = providerNumber;
    			
    			let message = '';
    			
    			for(let el of result['result']['logMessages']) {
    			    message += ' ' + el['messageTime'];
    			}
    			
    			let orderNumber = result['result']['clientOrderNumber'];
    			
                var xhr = new XMLHttpRequest();
        		xhr.open('POST', 'App/Controllers/editNewDeliveryOrder.php');
        
        		xhr.addEventListener('readystatechange', function(e) {
        			
        			if (xhr.readyState == 4 && xhr.status == 200 && e.target.response) {
        			    
        				console.log(e.target.response);
        			}
        			else if (xhr.readyState == 4 && (xhr.status != 200 || e.target.response.length == 0)) {
        				console.log('Не удалось сохранить новый заказ.');
        			}
        		});
        		
                var fd = new FormData;
        		
        		fd.append("orderNumber", orderNumber);
        		fd.append("orderId", orderId);
        		fd.append("providerNumber", providerNumber);
        		fd.append("message", message);
        		xhr.send(fd);
    			
    		}, function(status) {
    			console.log('Something went wrong.');
    		});
                
        } else {
            document.querySelector('.success__contact').style.display = "none";
            let orderId = ordersJSON[i]['ClientOrderNumber'];
    	    document.querySelector('#orderId').innerHTML = orderId;
    	    
    	    var xhr = new XMLHttpRequest();
    		xhr.open('POST', 'App/Controllers/editNewDeliveryOrder.php');
    
    		xhr.addEventListener('readystatechange', function(e) {
    			
    			if (xhr.readyState == 4 && xhr.status == 200 && e.target.response) {
    			    
    				console.log(e.target.response);
    			}
    			else if (xhr.readyState == 4 && (xhr.status != 200 || e.target.response.length == 0)) {
    				console.log('Не удалось сохранить новый заказ.');
    			}
    		});
    		
            var fd = new FormData;
    		
    		fd.append("orderNumber", '');
    		fd.append("orderId", orderId);
    		fd.append("providerNumber", '');
    		fd.append("message", '');
    		xhr.send(fd);
        }
		
		i++;
    }
</script>
	
<?php require(__DIR__ . "/files/html/footer.html");?>		
	
    </div>

<script src="App/templates/files/js/link_for_version2.js"></script>
</body></html>